import requests
import json
import random
import logging
import time
import os
import sys
from tor_init import TorInit
import configparser
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
parpath = os.path.abspath(os.path.join(os.path.dirname(__file__), os.path.pardir))
config = configparser.ConfigParser()
config.read(parpath + "/config.ini")
TXT_PATH = config.get("filepath", "txt_path")
SHA_LIST_FILE = config.get("sha_list", "filename")


class VTReportDownloader(object):

    def __init__(self, _url_list=[], socks_port=9050):
        self.url_list = _url_list
        self.user_agent = ''
        self.proxies = {
            'http': 'socks5h://127.0.0.1:{}'.format(socks_port),
            'https': 'socks5h://127.0.0.1:{}'.format(socks_port)
        }

    def _sys_sleep(self):
        u = random.uniform(0, 0.25)
        logging.info('system sleeps {} seconds...'.format(u))
        time.sleep(u)

    def get_page_source(self, url):
        if url is None:
            return None
        s = requests.Session()
        s.proxies = self.proxies
        headers = {
            'User-Agent': self.user_agent,
        }
        # Make the HTTP request through the session.
        r = s.get(url, headers=headers)
        # r = s.get(url)
        # Check if the proxy was indeed used (the text should contain the proxy IP).
        if r.status_code == 200:
            r.encoding = 'utf-8'
            html_contnet = r.text
            return html_contnet
        return None

    def save_report_2_txt(self, url):
        json_response = self.get_page_source(url)
        if json_response is None:
            logging.info('json_response is None.')
        # self._sys_sleep()
        if json_response is not None:
            sha256 = url.split('/')[-1]
            with open('{}.txt'.format(TXT_PATH + sha256), 'w') as f:
                f.write(json_response)

    def batch_save_report_2_txt(self):
        for i, u in enumerate(self.url_list):
            if i % 1000 == 0:
                print(i, 'th done.')

            logging.info('crawling vt report: {} ...'.format(u))
            json_response = self.get_page_source(u)
            # self._sys_sleep()
            if json_response is not None:
                sha256 = u.split('/')[-1]
                with open('{}.txt'.format(TXT_PATH + sha256), 'w') as f:
                    f.write(json_response)
            else:
                logging.info('json_response is None.')
                return 1


if __name__ == '__main__':

    tor = TorInit(socks_port=9050, control_port=9051)
    tor._startTorProxy()

    limit_try = 2000
    # next_url = None

    while limit_try > 0:

        try:
            done = [file.replace('.txt', '') for file in os.listdir(TXT_PATH) if file.endswith('.txt')]
            sha_list = [sha.replace('.danger', '') for sha in open(parpath + '/' + SHA_LIST_FILE, 'r').read().split('\n') if sha.endswith('.danger')]
            sha_list = set(sha_list) - set(done)
            logging.info('num of remaining shas: {}'.format(len(sha_list)))
            if sha_list == 0:
                limit_try = 0
                break

            for sha in sha_list:

                _url = 'https://www.virustotal.com/ui/files/{}'.format(sha)

                test = VTReportDownloader(socks_port=9050)
                report = test.get_page_source(_url)

                if report is not None:
                    with open('{}.txt'.format(TXT_PATH + sha), 'w') as f:
                        f.write(report)
                    logging.info('Report downloaded: {}'.format(sha))

                if report is None:
                    tor._checkTorStatus()
                    tor._startTorProxy()
                    limit_try -= 1
                    logging.info('restart tor process, limit try : {}'.format(limit_try))
                    continue

        except Exception as e:

            logging.info('fail dumps -- error on line {}: {}, limit try : {}'.format(sys.exc_info()[-1].tb_lineno, e, limit_try))
            if not limit_try:
                logging.info('finish total dumps')
                break
            limit_try -= 1

            tor._checkTorStatus()
            tor._startTorProxy()

            logging.info('restart tor process, limit try : {}'.format(limit_try))
