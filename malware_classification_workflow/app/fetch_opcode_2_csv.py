import os
import pickle
import pandas as pd
import glob


FROM_PATH = '/home/bensonbair/malware_classification_workflow/opcode_data/experiment_samples_0612/benign/'
DEST_PATH = '/home/bensonbair/malware_classification_workflow/csv_data/experiment_samples_0612/'


def clean_opcode(seq):
    fliter_opcode = ['assume', 'db', 'dd', '0', 'align']
    res = [word for word in seq if word not in fliter_opcode]
    return ' '.join(res)


def fetch_opc_to_csv(output_filename):
    virus_hash = []
    dataset = []
    labels = []
    c = 0
    n = 0
    
    for i, name in enumerate(glob.glob('{}/**.p'.format(FROM_PATH))):
        # if i > 10:
        #    continue
        opcode = pickle.load(open(name, 'rb'))
 
        if not opcode:
            c+=1
        else:
            n+=1
            dataset.append(clean_opcode(opcode))
            virus_hash.append(os.path.basename(name).strip('.ins.p'))
            labels.append(0)

    print('number of opcode is none: {}'.format(c))
    print('total number of opcodes transfered: {}'.format(n))
    print('len(dataset): {}, len(virus_hash): {}, len(labels): {}'.format(len(dataset), len(virus_hash), len(labels)))

    if len(dataset) == len(virus_hash) == len(labels):

        res = {'id':virus_hash, 'op_seq':dataset, 'label': labels}
        df = pd.DataFrame(res)

        df.to_csv(DEST_PATH + 'only_opcode_{}.csv'.format(output_filename), index=False)
    else:
        print('error')


if __name__ == '__main__':
    
    fetch_opc_to_csv('benign')











